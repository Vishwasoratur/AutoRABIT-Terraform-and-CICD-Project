version: 0.2
phases:
  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
      - REGION=$(aws configure get region)
      - ECR_REPO_URI="$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/devops-project-repo"
      - $(aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com)
      - echo "Authenticating with ECR successful."
      - echo "Updating terraform state with S3 backend configuration..."
      - cd terraform
      - terraform init -backend-config="bucket=vishwa-devops-project-terraform-state-2025" -backend-config="key=devops-project/terraform.tfstate" -backend-config="region=$REGION" -backend-config="dynamodb_table=vishwa-devops-project-terraform-locks"
      - echo "Terraform initialized."

  build:
    commands:
      - echo "Building the Docker image..."
      - docker build -t $ECR_REPO_URI:latest ..
      - docker tag $ECR_REPO_URI:latest $ECR_REPO_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - echo "Image built and tagged."

  post_build:
    commands:
      - echo "Pushing Docker images to ECR..."
      - docker push $ECR_REPO_URI:latest
      - docker push $ECR_REPO_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - echo "Docker images pushed to ECR."
      - echo "Running Terraform to update infrastructure (if needed)..."
      - terraform apply -auto-approve -var="github_owner=Vishwa-xyz" -var="github_repo_name=AutoRABIT" -var="github_connection_arn=arn:aws:codestar-connections:us-east-1:123456789012:connection/abcdef-1234-5678-90ab-cdef12345678"
      - echo "Terraform applied."

artifacts:
  files:
    - imagedefinitions.json