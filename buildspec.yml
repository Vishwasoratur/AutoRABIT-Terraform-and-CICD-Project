version: 0.2
runtime-versions:
  docker: 19

phases:
  install:
    commands:
      # Start the Docker daemon
      - nohup dockerd > /dev/null 2>&1 &
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"
      - echo "Docker daemon is running."
      
      # Corrected: Download and install Terraform
      - echo "Installing Terraform..."
      - curl -o terraform.zip https://releases.hashicorp.com/terraform/1.7.0/terraform_1.7.0_linux_amd64.zip
      - unzip -o -d /tmp terraform.zip
      - mv /tmp/terraform /usr/local/bin/
      - rm terraform.zip
      - terraform --version
      - echo "Terraform installed."

  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
      - REGION=$AWS_DEFAULT_REGION
      - ECR_REPO_URI="$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/devops-project-repo"
      - aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $ECR_REPO_URI
      - echo "Authenticating with ECR successful."
      - echo "Updating terraform state with S3 backend configuration..."
      # Use -chdir to run terraform init from within the terraform directory without changing the overall working directory.
      - terraform -chdir=terraform init -backend-config="bucket=vishwa-devops-project-terraform-state-2025-us-west-2" -backend-config="key=devops-project/terraform.tfstate" -backend-config="region=$REGION" -backend-config="dynamodb_table=vishwa-devops-project-terraform-locks"
      - echo "Terraform initialized."

  build:
    commands:
      - echo "Building the Docker image..."
      # The `docker build` command runs from the project root, where your Dockerfile is located.
      - docker build -t $ECR_REPO_URI:latest .
      - docker tag $ECR_REPO_URI:latest $ECR_REPO_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - echo "Image built and tagged."

  post_build:
    commands:
      - echo "Pushing Docker images to ECR..."
      - docker push $ECR_REPO_URI:latest
      - docker push $ECR_REPO_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - echo "Docker images pushed to ECR."
      - echo "Running Terraform to update infrastructure (if needed)..."
      # Use -chdir to run terraform apply from within the terraform directory.
      - terraform -chdir=terraform apply -auto-approve -var="github_owner=Vishwasoratur" -var="github_repo_name=AutoRABIT-Terraform-and-CICD-Project" -var="github_connection_arn=arn:aws:codeconnections:us-west-2:<YOUR_ACCOUNT_ID>:connection/<NEW_CONNECTION_ID>"
      - echo "Terraform applied."

artifacts:
  files:
    - imagedefinitions.json